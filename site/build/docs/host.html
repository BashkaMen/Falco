<!DOCTYPE html>
<html lang="en">

<!-- /head -->
<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  
      <title>Falco - F# web toolkit for ASP.NET Core</title>
    
  <meta name="description" content="A functional-first toolkit for building brilliant ASP.NET Core applications using F#.">

  <!-- /head/style -->
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <link href="/prism.css" rel="stylesheet" />
  <link href="/tachyons.css" rel="stylesheet" />
  <style>
    :root {
      --gray: rgba(51,51,51,.6);
      --silver: rgb(204, 204, 204);
      --slate: rgb(51, 51, 51);
      --merlot: rgb(50, 1, 79);
      --purple: rgb(184, 69, 252);
      --washed-purple: rgba(185, 69, 252, 0.10);
    }

    /* sizing */
    .h100vh { min-height: 100vh }
    .mw9 { max-width: 80rem }

    /* font */
    .noto { font-family: 'Noto Sans JP', sans-serif }
    .noto-serif { font-family: 'Noto Serif JP', Georgia, serif }

    /* bg */
    .bg-merlot { background-color: var(--merlot) }
    .bg-dots { background-image: radial-gradient(rgba(255,255,255,.3) 1px, transparent 1px), radial-gradient(rgba(255,255,255,.3) 1px, transparent 1px); background-size: 75px 75px; background-position: 0px 0px,40px 25px }
    .bg-parallax {  background-attachment: fixed }

    /* color */
    .merlot { color: var(--merlot) }

    /* opacity */
    .hover-o-100:hover { opacity: 1 }

    /* transform */
    .ty--50 { transform: translateY(-50%);}

    /* text */
    main h1, main h2, main h3, main h4, main h5 { margin-bottom: 0; font-weight: 400 }
    main h2 { margin-top: 3rem; font-size: 2em; color: var(--gray) }
    main h3 { margin-top: 2rem; font-size: 1.5em }
    main h2 + h3 { margin-top: .5rem }
    main p { line-height: 1.4 }

    a { color: inherit; transition: color .125s ease-in }
    main a:visited { color: inherit }
    main a:hover { color: var(--purple) }

    blockquote { margin-left: 0; margin-right: 0; padding: 1rem; border-left: 4px solid var(--purple); background: var(--washed-purple) }
    blockquote p { margin: 0 }

    /* tables */
    table { text-align: left; border-collapse: collapse }
    td, th { padding: .5rem; border-bottom: 1px solid var(--silver) }

    /* code */
    code[class*="language-"], pre[class*="language-"] { font-size: .875rem }
    pre[class*="language-"] { padding: 1rem }
    pre { overflow-x: auto; overflow-wrap: normal; white-space: pre; font-size: .875rem; margin: 1rem 0; padding: 1rem; color: #eff0f9; background: #333 }
    code { vertical-align: middle; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; background-color: var(--washed-purple) }
    pre > code { background-color: inherit }
    h2 > code, h3 > code, p > code { padding: 0 .25rem }
  </style>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D62HSJHMNZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D62HSJHMNZ');
  </script>
</head>

<!-- /body -->
<body class="noto bg-merlot bg-dots bg-parallax">

<!-- /body/header -->
<header class="pv3">
  <div class="mw8 center pa3">
    <!-- /top bar -->
    <div>
      <nav class="flex flex-column flex-row-l items-center">
        <a href="/"><img src="/icon.svg" class="w3 pb3 pb0-l o-80 hover-o-100" /></a>
        <div class="flex-grow-1-l tc tr-l">
          <a href="/docs" title="Overview of Falco's key features" class="dib mh2 mh3-l no-underline white-90 hover-white">docs</a>
          <a href="/docs/tutorial.html" title="A guide on how to write small, but complete application using Falco" class="dib mh2 mh3-l no-underline white-90 hover-white">guide</a>
          <a href="https://github.com/pimbrouwers/Falco"
             target="_blank"
             alt="Falco GitHub Link"
             title="Fork Falco on GitHub"
             class="dib ml2 ml3-l no-underline white-90 hover-white">code</a>
        </div>
      </nav>
    </div>
    
  </div>
</header>

<!-- /body/content -->
<div class="h100vh bg-white">
  <div class="cf mw8 center pv4 pv5-l ph3">
    <main><h1 id="host-configuration">Host Configuration</h1>
<p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel">Kestrel</a> is the web server at the heart of ASP.NET. It's performant, secure, and maintained by incredibly smart people. To make things more expressive, Falco exposes an optional computation expression. Below is an example taken from the <a href="https://github.com/pimbrouwers/Falco/tree/master/samples/ConfigureHost">Configure Host</a> sample, demonstrating some of the capabilities.</p>
<pre><code class="language-fsharp">module ConfigureHost.Program

open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

// Code omitted for brevity

[&lt;EntryPoint&gt;]
let main args =
    webHost args {
        use_ifnot FalcoExtensions.IsDevelopment HstsBuilderExtensions.UseHsts
        use_https
        use_compression
        use_static_files

        use_if    FalcoExtensions.IsDevelopment DeveloperExceptionPageExtensions.UseDeveloperExceptionPage
        use_ifnot FalcoExtensions.IsDevelopment (FalcoExtensions.UseFalcoExceptionHandler exceptionHandler)

        endpoints [
            // Endpoints and handlers
        ]
    }
    0
</code></pre>
<h2 id="registering-services">Registering Services</h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#add_antiforgery">add_antiforgery</a></td>
<td>Add Antiforgery support into the <code>IServiceCollection</code>.</td>
</tr>
<tr>
<td><a href="#add_cookie">add_cookie</a></td>
<td>Add default cookie authentication into the <code>IServiceCollection</code>.</td>
</tr>
<tr>
<td><a href="#add_conf_cookies">add_conf_cookies</a></td>
<td>Add configured cookie(s) authentication into the <code>IServiceCollection</code>.</td>
</tr>
<tr>
<td><a href="#add_authorization">add_authorization</a></td>
<td>Add default Authorization into the <code>IServiceCollection</code>.</td>
</tr>
<tr>
<td><a href="#add_data_protection">add_data_protection</a></td>
<td>Add file system based data protection.</td>
</tr>
<tr>
<td><a href="#add_http_client">add_http_client</a></td>
<td>Add IHttpClientFactory into the <code>IServiceCollection</code></td>
</tr>
</tbody>
</table>
<h3 id="add_antiforgery"><code>add_antiforgery</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    add_antiforgery

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="add_cookie"><code>add_cookie</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    add_cookie

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="add_conf_cookies"><code>add_conf_cookies</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Authentication
open Microsoft.AspNetCore.Authentication.Cookies
open Microsoft.AspNetCore.Builder

let appAuthScheme = &quot;MyApp&quot;

let authConfig
    (scheme : string)
    (opetions : AuthenticationOptions) =
    options.DefaultChallengeScheme &lt;- scheme
    options.DefaultAuthenticateScheme &lt;- scheme
    options.DefaultScheme &lt;- scheme

let cookieConfig
    let cookieOptions
        (scheme : string)
        (options : CookieAuthenticationOptions) =
        options.Cookie.Path &lt;- &quot;/&quot;
        options.Cookie.HttpOnly &lt;- true
        options.Cookie.SameSite &lt;- SameSiteMode.Strict
        options.Cookie.SecurePolicy &lt;- CookieSecurePolicy.Always

    [ appAuthScheme, cookieOptions appAuthScheme ]

webHost [||] {
    endpoints [
        add_conf_cookies authConfig cookieConfig

        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="add_authorization"><code>add_authorization</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    add_authorization

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="add_data_protection"><code>add_data_protection</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    add_data_protection &quot;C:\\Data\\Protection\\Dir&quot;

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="add_http_client"><code>add_http_client</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    add_http_client

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h2 id="activating-middleware">Activating Middleware</h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#use_if">use_if</a></td>
<td>Use the specified middleware if the provided predicate is &quot;true&quot;.</td>
</tr>
<tr>
<td><a href="#use_ifnot">use_ifnot</a></td>
<td>Use the specified middleware if the provided predicate is &quot;true&quot;.</td>
</tr>
<tr>
<td><a href="#use_authentication">use_authentication</a></td>
<td>Use authorization middleware. Call before any middleware that depends on users being authenticated.</td>
</tr>
<tr>
<td><a href="#use_authorization">use_authorization</a></td>
<td>Register authorization service and enable middleware</td>
</tr>
<tr>
<td><a href="#use_caching">use_caching</a></td>
<td>Register HTTP Response caching service and enable middleware.</td>
</tr>
<tr>
<td><a href="#use_compression">use_compression</a></td>
<td>Register Brotli + GZip HTTP Compression service and enable middleware.</td>
</tr>
<tr>
<td><a href="#use_hsts">use_hsts</a></td>
<td>Use automatic HSTS middleware (adds strict-transport-policy header).</td>
</tr>
<tr>
<td><a href="#use_https">use_https</a></td>
<td>Use automatic HTTPS redirection.</td>
</tr>
<tr>
<td><a href="#use_static_files">use_static_files</a></td>
<td>Use Static File middleware.</td>
</tr>
</tbody>
</table>
<h3 id="use_if"><code>use_if</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_if    FalcoExtensions.IsDevelopment DeveloperExceptionPageExtensions.UseDeveloperExceptionPage

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_ifnot"><code>use_ifnot</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_ifnot FalcoExtensions.IsDevelopment HstsBuilderExtensions.UseHsts

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_authentication"><code>use_authentication</code></h3>
<blockquote>
<p>Note: this must be called <strong>before</strong> <code>use_authorization</code>, and called <strong>after</strong> <code>use_hsts</code>, <code>use_http</code>, <code>use_compression</code>, <code>use_static_files</code>.</p>
</blockquote>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_authentication

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_authorization"><code>use_authorization</code></h3>
<blockquote>
<p>Note: this must be called <strong>after</strong> <code>use_authentication</code>.</p>
</blockquote>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_authorization

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_caching"><code>use_caching</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_caching

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_compression"><code>use_compression</code></h3>
<blockquote>
<p>Note: this should be called <strong>before</strong> <code>use_static_files</code> if compression is desired on static assets.</p>
</blockquote>
<p>In addition to the <a href="https://docs.microsoft.com/en-us/aspnet/core/performance/response-compression#mime-types">default MIME types</a>, this enables compression for the following: <code>image/jpeg</code>, <code>image/png</code>, <code>image/svg+xml</code>, <code>font/woff</code>, <code>font/woff2'</code>.</p>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_compression

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_hsts"><code>use_hsts</code></h3>
<blockquote>
<p>Note: this should be called <strong>before</strong> <code>use_https</code>.</p>
</blockquote>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_hsts

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_https"><code>use_https</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_https

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="use_static_files"><code>use_static_files</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

webHost [||] {
    use_static_files

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h2 id="custom-services-and-middleware">Custom Services and Middleware</h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#add_service">add_service</a></td>
<td>Add a new service descriptor into the IServiceCollection.</td>
</tr>
<tr>
<td><a href="#use_middleware">use_middleware</a></td>
<td>Use the specified middleware.</td>
</tr>
</tbody>
</table>
<h3 id="add_service"><code>add_service</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder
open Microsoft.Data.Sqlite

type IDbConnectionFactory =
    abstract member CreateConnection : unit -&gt; IDbConnection

type DbConnectionFactory (connectionString : string) =
    interface IDbConnectionFactory with
        member _.CreateConnection () =
            let conn = new SqliteConnection(connectionString)
            conn.TryOpenConnection()
            conn

[&lt;EntryPoint&gt;]
let main args =
    // Using the ConfigurationBuilder
    let config = configuration args {
        required_json &quot;appsettings.json&quot;
        add_env
    }

    // Register our database connection factory service
    let dbConnectionService (svc : IServiceCollection) =
        svc.AddSingleton&lt;IDbConnectionFactory, DbConnectionFactory&gt;(fun _ -&gt;
            // Load default connection string from appsettings.json
            let connectionString = config.GetConnectionString(&quot;Default&quot;)
            new DbConnectionFactory(connectionString))

    webHost [||] {
        endpoints [
            get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
        ]
    }
    0
</code></pre>
<h3 id="use_middleware"><code>use_middleware</code></h3>
<pre><code class="language-fsharp">open System.Globalization
open System.Threading.Tasks
open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder
open Microsoft.AspNetCore.Http

let displayCulture : HttpHandler = fun ctx -&gt;
    Response.ofPlainText CultureInfo.CurrentCulture.DisplayName ctx

let cultureMiddleware (app : IApplicationBuilder) =
    let middleware (ctx : HttpContext) (next : RequestDelegate) : Task =
        task {
            let query = QueryCollectionReader(ctx.Request.Query)
            match query.TryGet &quot;culture&quot; with
            | Some cultureQuery -&gt;
                let culture = CultureInfo(cultureQuery)
                CultureInfo.CurrentCulture &lt;- culture
                CultureInfo.CurrentUICulture &lt;- culture
            | None -&gt; ()

            return! next.Invoke(ctx)
        }

    app.Use(middleware)

webHost [||] {
    use_middleware cultureMiddleware

    endpoints [
        any &quot;/&quot; displayCulture
    ]
}
</code></pre>
<h2 id="other-operations">Other Operations</h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#logging">logging</a></td>
<td>Configure logging via <code>ILogger</code>.</td>
</tr>
<tr>
<td><a href="#not_found">not_found</a></td>
<td>Include a catch-all (i.e., Not Found) HttpHandler (must be added last).</td>
</tr>
</tbody>
</table>
<h3 id="logging"><code>logging</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder
open Microsoft.Extensions.Logging

let configureLogging (log : ILoggingBuilder) =
    log.ClearProviders()
    log.AddConsole()
    log

webHost [||] {
    logging configureLogging

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
<h3 id="not_found"><code>not_found</code></h3>
<pre><code class="language-fsharp">open Falco
open Falco.Routing
open Falco.HostBuilder
open Microsoft.AspNetCore.Builder

module ErrorPages =
    let unauthorized : HttpHandler =
        Response.withStatusCode 404
        &gt;&gt; Response.ofPlainText &quot;Not Found&quot;

webHost [||] {
    not_found ErrorPages.notFound

    endpoints [
        get &quot;/&quot; (Response.ofPlainText &quot;Hello world&quot;)
    ]
}
</code></pre>
</main>
  </div>
</div>

<!-- /body/footer -->
<footer class="tc ph3 pv4">
  <div class="f6 white-90">&copy; 2020-2022 Pim Brouwers & contributors.</div>
</footer>

<!-- /body/script -->
<script src="/prism.js"></script>

</body>
</html>
